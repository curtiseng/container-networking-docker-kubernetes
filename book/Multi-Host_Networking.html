<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>第三章 介绍多主机的网络 - Container Networking Dokcer Kubernetes</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="Preface.html">序言</a></li><li><a href="Mptivation.html"><strong aria-hidden="true">1.</strong> 第一章 本书的写作动机</a></li><li><a href="Introduction_to_Container_Networking.html"><strong aria-hidden="true">2.</strong> 第二章 介绍容器网络</a></li><li><a href="Multi-Host_Networking.html" class="active"><strong aria-hidden="true">3.</strong> 第三章 介绍多主机的网络</a></li><li><a href="TBD.html"><strong aria-hidden="true">4.</strong> 第四章 编排</a></li><li><a href="TBD.html"><strong aria-hidden="true">5.</strong> 第五章 服务发现</a></li><li><a href="TBD.html"><strong aria-hidden="true">6.</strong> 第六章 容器网络接口</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.</strong> 第七章 Kubernetes 网络</a></li><li><ol class="section"><li><a href="TBD.html"><strong aria-hidden="true">7.1.</strong> Kubernetes 简介</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.2.</strong> Kubernetes 网络简介</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.3.</strong> Pod 内部网络通信</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.4.</strong> Pod 间网络通信</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.5.</strong> Kubernetes 中的服务发现</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.6.</strong> Ingress 和 Egress</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.7.</strong> Kubernetes 网络的高级主题</a></li><li><a href="TBD.html"><strong aria-hidden="true">7.8.</strong> 本章小结</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Container Networking Dokcer Kubernetes</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#第三章-跨主机网络" id="第三章-跨主机网络"><h3>第三章 跨主机网络</h3></a>
<hr />
<p>只在单个主机上使用容器，第2章中介绍的技术就足够了。然而，如果单个主机的容量不足以处理您的工作负载，或者您想要更多的弹性，那么您需要水平扩展。</p>
<a class="header" href="#多主机容器网络" id="多主机容器网络"><h4>多主机容器网络</h4></a>
<p>当水平扩展时，最终会得到一个跨机器网络，也称为机器集群，简称集群。现在，有一些问题：不同主机上的容器如何互相通信？容器间如何通讯，并且和外部网络通讯？如何保持集群中的状态(例如IP地址分配)一致?与现有网络基础设施的集成点是什么?那么安全策略呢?</p>
<p>为了解决这些问题，我们将在本章的剩余部分中回顾多主机托管网络的技术。由于不同的用例和环境有不同的需求，我将避免为特定的项目或产品提供推荐。你应该意识到权衡利弊，做出明智的决定。</p>
<a class="header" href="#多主机网络的选择" id="多主机网络的选择"><h4>多主机网络的选择</h4></a>
<p>简而言之，Docker本身提供了对覆盖网络(在主机特定网络上创建跨主机的分布式网络)的支持，以及为第三方提供商提供的网络工作插件。</p>
<p>实践中经常使用许多多主机容器联网选项，尤其是在Kubernetes环境中。这些包括:</p>
<ul>
<li>Flannel by CoreOS</li>
<li>Weave Net by Weaveworks</li>
<li>Metaswitch’s Project Calico</li>
<li>Open vSwitch from the OpenStack project</li>
<li>OpenVPN</li>
</ul>
<p>另外，Docker本身提供了多主机联网。</p>
<a class="header" href="#flannel" id="flannel"><h5>flannel</h5></a>
<p>CoreOS的flannel是一个虚拟网络，为每个主机分配子网，供容器运行时使用。对于Kubernetes来说，每个容器豆荚在集群中都有一个惟一的、可路由的IP。flannel支持一系列后端，比如VXLAN、AWS VPC和默认L2 UDP网络。flannel的优点是它减少了做端口映射的复杂性。Red Hat的项目Atomic使用flannel。</p>
<a class="header" href="#weave-net" id="weave-net"><h5>Weave Net</h5></a>
<p>Weaveworks的WeaveNet创建了一个虚拟网络，将部署在多台主机上的Docker包含服务器连接起来。应用程序使用网络就像所有的容器都插入同一个网络交换机一样，不需要考虑端口映射和链接。Weave网络上的应用程序容器提供的服务可以让外界访问，而不管这些容器在哪里运行。</p>
<p>类似地，现有的内部系统也可以暴露在应用程序容器中，以反映其位置。Weave可以穿越防火墙，在部分连接的网络中运行。流量可以加密，允许主机通过不受信任的网络连接。您可以在Alvaro Saurin的博客文章“使用Weave discovery自动部署Docker主机”中了解更多Weave的发现。</p>
<a class="header" href="#project-calico" id="project-calico"><h5>Project Calico</h5></a>
<p>Metaswitch的Project Calico使用标准IP路由来精确定位，如RFC 1105中定义的值得尊敬的边界网关协议(BGP)和网络工具来提供第三层解决方案。相比之下，大多数其他网络解决方案通过将第2层流量封装到更高的层来构建覆盖网络。</p>
<p>主操作模式不需要封装，它是为数据中心设计的，组织可以在数据中心控制物理网络结构。还可以查看Canal，它将Calico的网络政策执行与丰富的Calico和法兰绒覆盖和非覆盖网络连接结合在一起。</p>
<a class="header" href="#open-vswitch" id="open-vswitch"><h5>Open vSwitch</h5></a>
<p>Open vSwitch是一种多层虚拟交换机，旨在通过编程扩展实现网络自动化，同时支持标准管理接口和协议，如NetFlow、IPFIX、LACP和802.1ag。另外，它被设计用于支持跨多个物理服务器的分发，并用于Red Hat的Kubernetes发行版OpenShift中，这是Xen、KVM、Proxmox VE和VirtualBox中的默认开关。它还被集成到许多私有云系统中，例如OpenStack和oVirt。</p>
<a class="header" href="#openvpn" id="openvpn"><h5>OpenVPN</h5></a>
<p>OpenVPN是另一个具有商业功能的OSS项目，它允许您使用TLS创建虚拟专用网(vpn)。这些vpn还可以用于通过公共internet安全地将容器连接到彼此。如果您想尝试基于Docker的设置，我建议您看看DigitalOcean的“<a href="https://www.digitalocean.com/community/tutorials/how-to-run-openvpn-in-a-docker-container-on-ubuntu-14-04">如何在Ubuntu 14.04的Docker容器中运行OpenVPN</a>”演练教程。</p>
<a class="header" href="#docker-networking" id="docker-networking"><h4>Docker Networking</h4></a>
<p>Docker 1.9引入了一个新的Docker命令<code>network</code>。这样，容器就可以动态地连接到其他网络，每个网络都可能由不同的网络驱动程序支持。</p>
<p>2015年3月，Docker公司收购了SDN创业公司SocketPlane，并将其产品更名为Overlay Driver。从Docker 1.9开始，这是多主机网络的默认设置。覆盖驱动程序通过对等通信扩展了普通的桥接模式，并使用可插入的键-值存储后端来分发集群状态、支持领事、etcd和ZooKeeper。</p>
<p>为了了解更多，我建议看看以下的博客文章:</p>
<ul>
<li>Aleksandr Tarasov’s “<a href="http://developerblog.info/2015/11/16/splendors-and-miseries-of-docker-network/">Splendors and Miseries of Docker Network</a>”</li>
<li>Project Calico’s “<a href="https://www.projectcalico.org/docker-libnetwork-is-almost-here-and-calico-is-ready">Docker 1.9 Includes Network Plugin Support and Calico Is Ready</a>”</li>
</ul>
<a class="header" href="#管理方面的考虑" id="管理方面的考虑"><h4>管理方面的考虑</h4></a>
<p>在本章的最后一节中，我们将讨论一些您应该注意的管理方面:</p>
<p><strong><em>IPVLAN</em></strong></p>
<p>Linux内核版本3.19引入了IP-per-container特性。这将为主机上的每个容器分配一个惟一的、可路由的IP地址。高效地说，IPVLAN采用一个网络接口，并创建多个虚拟网络接口，这些虚拟网络接口具有分配给它们的不同MAC地址。</p>
<p>这个功能是由谷歌的Mahesh Bandewar贡献的，它在本质上类似于macvlan驱动程序，但更灵活，因为它同时适用于L2和L3。如果您的Linux发行版已经有了内核&gt; 3.19，那么您就很幸运了。否则，您还不能从这个特性中获益。</p>
<p><strong><em>IP address management (IPAM)</em></strong></p>
<p>多主机联网的关键挑战之一是将IP地址分配给集群中的容器。可以采取两种策略:要么在你现有的(公司)网络中找到实现它的方法，要么衍生出一个正交的、实际上是隐藏的网络层(即一个覆盖网络)。注意，使用IPv6时这种情况比较宽松，因为找到一个空闲地址空间应该容易得多。</p>
<p><strong><em>Orchestration tool compatibility</em></strong></p>
<p>本章中讨论的许多多主机网络解决方案实际上都是封装Docker API并为您配置网络工作。这意味着在选择一个工具之前，您应该确保检查与您正在使用的容器编排工具的兼容性问题。你会在第四章找到更多关于这个主题的内容。</p>
<p><strong><em>IPv4 versus IPv6</em></strong></p>
<p>到目前为止，大多数Docker部署都使用标准的IPv4，但是IPv6却有一些优势。Docker自2015年2月发布v1.5以来一直支持IPv6;然而，IPv6在Kubernetes的支持还没有完成。IPv4-land日益增长的地址短缺可能会鼓励更多的IPv6部署，也会消除网络地址转换(NAT)，但目前还不清楚<a href="https://www.youtube.com/watch?v=eF50OxZ5u4o">何时会达到临界点</a>。</p>
<a class="header" href="#总结" id="总结"><h4>总结</h4></a>
<p>在本章中，我们回顾了多主机网络选项，并讨论了管理问题，如IPAM和编配。在这个关键时刻，您应该很好地理解低级别的单主机和多主机联网选项及其挑战。现在让我们继续讨论容器编排，看看它如何依赖于网络以及如何与之交互。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="Introduction_to_Container_Networking.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="TBD.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="Introduction_to_Container_Networking.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="TBD.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
